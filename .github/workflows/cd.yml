name: Build and Push Docker Image

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # Étape 1 : Récupérer le code du repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- DÉBUT DES NOUVELLES ÉTAPES FLAKE8 ---

      # Étape 2 : Configurer l'environnement Python
      # Flake8 est un outil Python. Nous configurons la version pour l'environnement de la CI.
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # Utilise la dernière version stable de Python 3

      # Étape 3 : Installer Flake8 (et les dépendances du projet si nécessaire)
      - name: Install dependencies and Flake8
        run: |
          python -m pip install --upgrade pip
          pip install flake8
          # Si votre code dépend d'un requirements.txt, décommentez la ligne ci-dessous :
          # pip install -r requirements.txt
          
      # Étape 4 : Exécuter l'analyse de qualité Flake8
      # Le point (.). analyse tous les fichiers Python dans le répertoire courant.
      # L'étape échouera si Flake8 trouve des erreurs ou des avertissements majeurs (le code 
      # n'est pas construit si le linter échoue).
      - name: Run Flake8 code quality checks
        run: |
          echo "Démarrage de l'analyse de qualité Flake8..."
          flake8 . --count --show-source --statistics
          echo "Analyse Flake8 terminée avec succès."

      # --- FIN DES ÉTAPES FLAKE8 ---
      
      # Étape 5 : Se connecter à Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Étape 6 : Builder et tagger l’image
      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/fastapi-demo:latest .

      # Étape 7 : Pousser l’image sur Docker Hub
      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/fastapi-demo:latest